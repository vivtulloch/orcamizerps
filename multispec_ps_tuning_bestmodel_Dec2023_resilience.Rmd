---
title: "Orca_tuneparams_Nov2023_calibrate to fishing"
author: "Viv Tulloch"
date: "2023-11-27"
output: html_document
---


https://course.mizer.sizespectrum.org/build/find-species-parameters.html

## Create a mizer model

```{r message=FALSE}
try(unload("mizerExperimental"), silent = TRUE)
remotes::install_github("sizespectrum/mizerExperimental", quiet = TRUE)
library(mizerExperimental)
library(tidyverse)
```



```{r}
#Open model 
cur_model <-readParams("C:/~/orcamizerps_upd/bestmodel_231127_nofishing_tuneparams.rds")
#species_params(params) |> select(erepro)

```


```{r FALSE}
#remotes::install_github('sizespectrum/mizerExperimental', ref = 'tuneMR')
#library(mizerExperimental)
#tuneParams(cm_tuned)
```

```{r}
# run without fishing
sim <- project(cur_model, t_max = 1, effort =0.1, t_save=3)

plot(sim)
animateSpectra(sim, total = TRUE, power = 1)#, 
               #ylim = c(1e-8, NA), wlim = c(1e-3, NA))

```

```{r}

paramsn <- setInitialValues(cur_model, sim)

#read in time-averaged  catches 
#params<- cur_model
cdat<-read.csv(
  "C:/Users/vtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Puget_Sound/spp_Aug2023_CM/fisheries/ts_fisheries_rev_avyield_rmzoo.csv") ### units: tonnes

# the fishing moratlty rates are already stored in the param object as
paramsn @species_params$catchability<-cdat$catchability
paramsn @species_params$catchability


species_params(paramsn)$yield_observed <- cdat$yield_observed
paramsn @species_params$yield_observed
paramsn @species_params$biomass_observed

paramsn2 <- calibrateYield(paramsn)

#plotYieldVsSpecies(paramsn2)
plotYieldObservedVsModel(paramsn2)
```


plotYieldVsSpecies(paramsn2)




```{r}
df1<-species_params(paramsn2)
write.csv(df1,
  "C:/Users/vtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Puget_Sound/spp_Aug2023_CM/bestmodel_outputparams_231127_addfishinpars.csv") ### units: tonnes
```



Species are coexisting. This is in part because we applied a stronger  Rmax effect for larger species. You can play with the above parameters but but it would take a lot of trial an error to achieve the right combination to get the biomass or catches similar to the observations.

 - but pinnipeds are being outcompeted????

#### Step 2. Calibrate the carrying capacity of the background resource spectrum, \kappa, by minimising the error between the modelled and observed  abundance, biomass or catches. 

We could explore the effects further using Rshiny app, where we also have a plot of the biomass or catch data. First lets' look at the basic diagnostics and tune kappa and erepro to make sure the feeding levels are high enough for each species. 


```{r}
plotBiomassVsSpecies(paramsn2)
cur_model <- calibrateBiomass(paramsn2)
#cur_model <- matchBiomasses(cur_model)
plotBiomassVsSpecies(cur_model)
plotYieldVsSpecies(cur_model)
#tuneParams(params)
# is there a way to save the final chosen values?
params@resource_params$kappa
```


need to update gear_params catchability
catchability
0.001465922,1.49E-06,0.020425786,0.006316173,0.006369784,0.001124779,0.031044642,0.121768151,0.020000653,0.032180443,0.024686121,0.013064699,0.008152937,0.007719593,0.013376173,0,0,0,0,0

```{r}
gear_params(paramsn2)$yield_observed <- cdat$yield_observed

 gear_params(paramsn2)$catchability <- cdat$catchability
 gear_params(paramsn2)
 plotYieldVsSize(paramsn2)
```


```{r}
cur_model <- steady(paramsn2)
plotSpectra(cur_model)
 
```

```{r}

 
```








```{r}
df1<-species_params(cur_model)
write.csv(df1,
  "C:/Users/vtulloch/Dropbox/UBC/Projects/Orca_salmon_modelling/07_sizespectra/Viv_sizespectra_model/Puget_Sound/spp_Aug2023_CM/bestmodel_outputparams_231127_addfishinpars_upd.csv") ### units: tonnes
saveParams(cur_model, "bestmodel_231127_fishingpars_tuneparams.rds")
```



















```{r}
# run without fishing
sim2 <- project(cur_model, t_max = 100, effort =1, t_save=3)

plot(sim2)
animateSpectra(sim2, total = TRUE, power = 1)#, 
               #ylim = c(1e-8, NA), wlim = c(1e-3, NA))

 
```
try a bigger kappa? 38911829949.3564


> cur_model@resource_params$kappa
[1] 45062646192
[2] 33911829949

#### Step 3. Calibrate the maximum recruitment, \Rmax, which will affect the relative biomass of each species (and, combined with the fishing parameters, the catches) by minimising the error between observed and estimated catches or biomasses. We could also include kappa in our estimation here (as in Blanchard et al 2104 & Spence et al 2016) but instead we will use the value that seemed OK in terms of feeding levels in the shiny app, roughly log10(11.5). Same goes for erepro, a value of 1e-2 seemed ok.

try the course method

```{r}
tuneParams(params)
#getReproductionLevel(params)
#species_params(params) |> select(erepro)
getRDI(params)/getRDD(params)

```



This might take AWHILE. Go watch some Netflix.

```{r}


# change kappa and erepro based on shiny epxloration
 params@species_params$erepro[] <-1e-3
  params <- setParams(params,kappa=33911829949.3564)

# define the initial parameters to send to optimisation code below

# we need 12 Rmaxs, log10 scale
vary <- log10(1000*params@resource_params$kappa*params@species_params$w_inf^-1)
#vary<-runif(10,3,22) # or use completley made up values, same for each species test for effects of initial values

#the following getError function combines the steps of the optimisastion above - this time with the multispecies model and output the predicted size spectrum

getError <- function(vary,params=initparam,dat=cdat$yield_observed,data_type="catch",timetorun=100) {
  params@species_params$R_max[]<-10^vary[1:22]
  sim <- project(params, effort = 1, t_max = timetorun, dt=0.1)
          ## what kind of data and output do we have?
          if (data_type=="Biomass") {
          output <-getBiomass(sim)[timetorun,]   #could change to getBiomass if appropriate, also check units.
          }
          #if (data_type=="catch") {
         #output <-getYield(sim)[timetorun,]*1e6 #### CHECK UNITS !! grams per year? the data are in tonnes per year so converting to tonnes.
         # }
  pred <- log(output)
  dat  <- log(dat)

  # sum of squared errors, here on log-scale of predictions and data (could change this or use other error or likelihood options)
   discrep <- pred - dat

   discrep <- (sum(discrep^2))
  
  # can use a strong penalty on the error to ensure we reach a minimum of 10% of the data (biomass or catch) for each species
  #if(any(pred < 0.1*dat)) discrep <- discrep + 1e10
  
    return(discrep)

   }

## test it

initparams <- params

#err<-getError(vary,params,dat=cdat$yield_observed,data_type="catch")
#err
err<-getError(vary,params,dat=rep(100,22),data_type="biomass")
#test
err



# this time carry out optimisation, using optim(), with catches
vals<-optim(par=vary,getError,params=initparams,method ="L-BFGS-B",lower=c(rep(3,22)),upper= c(rep(20,22)))



# plug back into model
# make sure kappa and erepro are the same
params@species_params$erepro[] <-1e-4
params <- setParams(params,kappa=33911829949.3564)
# optim values:
params@species_params$R_max <- 10^vals$par[1:22] 
# set the param object
params<-setParams(params)
sim <- project(params, effort = 1, t_max = 500, dt=0.1)
plot(sim)

# and without fishing?
sim_uf <- project(params, effort = 0, t_max = 500, dt=0.1)
plot(sim_uf)

# save vals - may want to repeat this setp depending on diagnostics, after changing some parameters
saveRDS(vals,"optim_vals.RDS")

# save params - may want to repeat this setp depending on diagnostics, after changing some parameters
saveRDS(params,"optim_param.RDS")
saveRDS(sim,"optim_sim.RDS")


```




#### Step 4. Check that the physiological recruitment, \RDI, is much higher than the realised recruitment, \RDD. High RDI/RDD ratio.




```{r}
#params<- readRDS("optim_param.RDS")
#sim <- readRDS("optim_sim.RDS")
getRDI(cm_tuned)/getRDD(cm_tuned)

# seems like the right ballpark according to protocal

params2<-cm_tuned

# # if needed change erepro & plug back into model
 params2@species_params$erepro[] <-1e-3
 params2 <- setParams(params2)
 sim2 <- project(params2, effort = 1, t_max = 100, dt=0.1)
 plot(sim2)

```